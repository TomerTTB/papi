<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PHI Headers Suite - API Testing Platform</title>
    <!-- Inter Font -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Custom CSS -->
    <link href="../styles/common.css" rel="stylesheet">
    <link href="styles/docs.css" rel="stylesheet">
</head>
<body>
    <!-- Header Placeholder -->
    <div id="header-placeholder"></div>

    <!-- Main Content -->
    <main class="main-content">
        <div class="container">
            <!-- Breadcrumb -->
            <nav aria-label="breadcrumb" class="mt-3 mb-4">
                <ol class="breadcrumb">
                    <li class="breadcrumb-item"><a href="/" class="text-decoration-none">Home</a></li>
                    <li class="breadcrumb-item"><a href="/docs" class="text-decoration-none">Documentation</a></li>
                    <li class="breadcrumb-item active">PHI Headers Suite</li>
                </ol>
            </nav>

            <div class="row">
                <!-- Sidebar Navigation -->
                <div id="sidebar-placeholder"></div>

                <!-- Documentation Content -->
                <div class="col-md-9">
                    <div class="wiki-content">
                        <h1>PHI Headers Suite Documentation</h1>
                        <div class="alert alert-info">
                            <h4 class="h5">Summary</h4>
                            <p>
                                The PHI Headers Suite validates API endpoints that require a valid PHI SID (Session ID) for authentication and session management. It ensures correct handling of required headers, security, and error responses for PHI-specific scenarios, with a focus on header validation and access control.
                            </p>
                        </div>

                        <h2 id="phi-tests">PHI Headers Test Cases Overview</h2>
                        <ol>
                            <li><strong>Content-Type Header Validation</strong>
                                <ul>
                                    <li>Verifies all responses include the <code>Content-Type: application/json</code> header.</li>
                                </ul>
                                <pre class="bg-dark text-light p-3">test('Response Has Correct Content-Type', async ({ request }) => {
    // ... obtain PHI SID if needed ...
    const response = await executeRequest(test, request, endpoint, headers);
    expect(response.headers()['content-type']).toContain('application/json');
});</pre>
                            </li>
                            <li><strong>Cache-Control Directives</strong>
                                <ul>
                                    <li>Ensures the response includes all required cache-control directives: <code>no-store</code>, <code>no-cache</code>, <code>must-revalidate</code>, <code>private</code>.</li>
                                </ul>
                                <pre class="bg-dark text-light p-3">test('Cache Control Directives', async ({ request }, testInfo) => {
    // ... obtain PHI SID if needed ...
    const response = await executeRequest(test, request, endpoint, headers);
    const cacheControl = response.headers()['cache-control'];
    const directives = cacheControl.split(',').map(d => d.trim());
    expect(directives).toContain('no-store');
    expect(directives).toContain('no-cache');
    expect(directives).toContain('must-revalidate');
    expect(directives).toContain('private');
});</pre>
                            </li>
                            <li><strong>Connection Header</strong>
                                <ul>
                                    <li>Ensures the <code>connection</code> header is set to <code>keep-alive</code>.</li>
                                </ul>
                                <pre class="bg-dark text-light p-3">test('Verify Connection header is keep-alive', async ({ request }) => {
    // ... obtain PHI SID if needed ...
    const response = await executeRequest(test, request, endpoint, headers);
    expect(response.headers()['connection']).toBe('keep-alive');
});</pre>
                            </li>
                            <li><strong>AWS API Gateway Headers</strong>
                                <ul>
                                    <li>Ensures required AWS headers (<code>x-amzn-requestid</code>, <code>x-amz-apigw-id</code>, <code>x-amzn-trace-id</code>) are present in the response.</li>
                                </ul>
                                <pre class="bg-dark text-light p-3">test('Required AWS Headers Present', async ({ request }) => {
    // ... obtain PHI SID if needed ...
    const response = await executeRequest(test, request, endpoint, headers);
    const responseHeaders = response.headers();
    const requiredHeaders = [
        'x-amzn-requestid',
        'x-amz-apigw-id',
        'x-amzn-trace-id',
    ];
    for (const headerName of requiredHeaders) {
        expect(responseHeaders[headerName.toLowerCase()]).toBeDefined();
    }
});</pre>
                            </li>
                            <li><strong>x-api-key Header Validation</strong>
                                <ul>
                                    <li><strong>Missing x-api-key:</strong> Returns 403 Forbidden with a "Forbidden" message.</li>
                                    <li><strong>Empty x-api-key:</strong> Returns 403 Forbidden with a "Forbidden" message.</li>
                                    <li><strong>Invalid x-api-key:</strong> Returns 403 Forbidden with a "Forbidden" message.</li>
                                </ul>
                                <pre class="bg-dark text-light p-3">test('Missing Headers Validation', async ({ request }) => {
    // ... obtain PHI SID if needed ...
    const headers = { ...endpoint.config.requiredHeaders };
    delete headers['X-Api-Key'];
    const response = await executeRequest(test, request, endpoint, headers);
    expect(response.status()).toBe(403);
    expect((await response.json()).message).toContain("Forbidden");
});

test('Empty Headers Validation', async ({ request }) => {
    // ... obtain PHI SID if needed ...
    const headers = { ...endpoint.config.requiredHeaders };
    headers['X-Api-Key'] = '';
    const response = await executeRequest(test, request, endpoint, headers);
    expect(response.status()).toBe(403);
    expect((await response.json()).message).toContain("Forbidden");
});

test('Invalid Header Values', async ({ request }) => {
    // ... obtain PHI SID if needed ...
    const headers = { ...endpoint.config.requiredHeaders };
    headers['x-api-key'] = 'invalid_value';
    const response = await executeRequest(test, request, endpoint, headers);
    expect(response.status()).toBe(403);
    expect((await response.json()).message).toContain("Forbidden");
});</pre>
                            </li>
                            <li><strong>PHI SID Handling</strong>
                                <ul>
                                    <li>For endpoints like <code>go_eyes</code> and <code>user_details_stage</code>, a new PHI SID is obtained and injected into the request body before each test.</li>
                                </ul>
                                <pre class="bg-dark text-light p-3">// Example usage in each test
if (endpoint.path === 'go_eyes' || endpoint.path === 'user_details_stage') {
    const newPhiSid = await getNewPhiSid(test, request);
    endpoint.config.requestBody.phi_sid = newPhiSid;
}</pre>
                            </li>
                        </ol>

                        <h3>PHI SID Update Mechanism</h3>
                        <p>
                            The PHI SID update process is handled by a helper module (e.g., <code>phiSidUpdater.js</code>):
                        </p>
                        <ul>
                            <li>Detects PHI endpoints (such as <code>go_eyes</code> and <code>user_details_stage</code>).</li>
                            <li>Obtains a new PHI SID from the questionnaire stage endpoint.</li>
                            <li>Updates the request body with the new PHI SID before each test.</li>
                        </ul>
                        <pre class="bg-dark text-light p-3">async function getNewPhiSid(test, request) {
    // 1. Temporarily switch to PHI base URL
    // 2. Call questionnaire_stage endpoint
    // 3. Extract new PHI SID from response
    // 4. Return the new PHI SID for use in tests
}</pre>

                        <h3>Configuration</h3>
                        <p>
                            The PHI test suite uses specific configuration elements:
                        </p>
                        <ul>
                            <li><strong>Environment Variables:</strong>
                                <ul>
                                    <li>PHI_BASE_URL: Base URL for PHI endpoints (defaults to https://phi-staging.6over6.com)</li>
                                </ul>
                            </li>
                            <li><strong>Endpoint Configuration:</strong>
                                <ul>
                                    <li>product: 'PHI' identifier</li>
                                    <li>Required headers specific to PHI endpoints</li>
                                </ul>
                            </li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- Footer Placeholder -->
    <div id="footer-placeholder"></div>

    <!-- Bootstrap JS and dependencies -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <!-- Template Loader -->
    <script src="../scripts/template-loader.js"></script>
    <!-- Version Fetcher -->
    <script src="../scripts/version-fetcher.js"></script>
    <!-- Sidebar Loader -->
    <script src="scripts/sidebar-loader.js"></script>
    <!-- Documentation Scripts -->
    <script src="scripts/docs.js"></script>
</body>
</html> 