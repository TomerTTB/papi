<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mock Server Configuration</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        .endpoint-card {
            margin-bottom: 20px;
        }
        .response-preview {
            max-height: 200px;
            overflow-y: auto;
        }
        .update-status {
            display: none;
            font-size: 0.9em;
            margin-top: 5px;
        }
        .update-status.show {
            display: block;
            animation: fadeOut 3s forwards;
            animation-delay: 2s;
        }
        @keyframes fadeOut {
            from { opacity: 1; }
            to { opacity: 0; }
        }
    </style>
</head>
<body>
    <div class="container mt-4">
        <h1>Mock Server Configuration</h1>
        <div class="row" id="endpoints">
            <!-- Endpoint cards will be dynamically inserted here -->
        </div>
    </div>

    <template id="endpoint-template">
        <div class="col-md-4">
            <div class="card endpoint-card">
                <div class="card-header">
                    <h5 class="card-title mb-0 text-break">http://localhost:3003/{endpoint}</h5>
                </div>
                <div class="card-body">
                    <div class="mb-3">
                        <label class="form-label">Status Code:</label>
                        <input type="number" class="form-control status-code" value="200">
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Response Delay (ms):</label>
                        <input type="number" class="form-control delay" value="0" min="0">
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Response Body (JSON):</label>
                        <textarea class="form-control response-body" rows="4"></textarea>
                    </div>
                    <div class="mb-3">
                        <button class="btn btn-primary update-btn">Update</button>
                        <button class="btn btn-secondary test-btn ms-2">Test</button>
                        <div class="update-status text-success"></div>
                    </div>
                    <div class="response-preview">
                        <small class="text-muted">Test Response:</small>
                        <pre class="test-response mt-2"></pre>
                    </div>
                </div>
            </div>
        </div>
    </template>

    <script src="https://cdn.socket.io/4.7.1/socket.io.min.js"></script>
    <script>
        const socket = io('http://localhost:3003');
        const endpoints = ['a', 'b', 'c'];
        const template = document.getElementById('endpoint-template');
        const container = document.getElementById('endpoints');
        const statusElements = {};

        // Create endpoint cards
        endpoints.forEach(endpoint => {
            const card = template.content.cloneNode(true);
            card.querySelector('.card-title').textContent = `Endpoint /${endpoint}`;
            
            const statusInput = card.querySelector('.status-code');
            const delayInput = card.querySelector('.delay');
            const bodyInput = card.querySelector('.response-body');
            const updateBtn = card.querySelector('.update-btn');
            const testBtn = card.querySelector('.test-btn');
            const testResponse = card.querySelector('.test-response');
            const updateStatus = card.querySelector('.update-status');

            // Update configuration
            updateBtn.addEventListener('click', () => {
                try {
                    const config = {
                        [endpoint]: {
                            statusCode: parseInt(statusInput.value),
                            delay: parseInt(delayInput.value),
                            body: JSON.parse(bodyInput.value)
                        }
                    };
                    socket.emit('updateConfig', config);
                    updateBtn.disabled = true;
                    updateStatus.textContent = 'Updating...';
                    updateStatus.classList.remove('text-success');
                    updateStatus.classList.add('text-warning', 'show');
                } catch (error) {
                    alert('Invalid JSON in response body');
                }
            });

            // Test endpoint
            testBtn.addEventListener('click', async () => {
                try {
                    testBtn.disabled = true;
                    const start = Date.now();
                    const response = await fetch(`http://localhost:3003/${endpoint}`);
                    const data = await response.json();
                    const duration = Date.now() - start;
                    
                    testResponse.textContent = 
                        `Status: ${response.status}\n` +
                        `Duration: ${duration}ms\n` +
                        `Body: ${JSON.stringify(data, null, 2)}`;
                } catch (error) {
                    testResponse.textContent = `Error: ${error.message}`;
                } finally {
                    testBtn.disabled = false;
                }
            });

            container.appendChild(card);

            // Store elements for later updates
            container[endpoint] = { statusInput, delayInput, bodyInput, updateBtn, updateStatus };
            statusElements[endpoint] = updateStatus;
        });

        // Handle configuration updates
        socket.on('configUpdate', (configs) => {
            Object.entries(configs).forEach(([endpoint, config]) => {
                const elements = container[endpoint];
                if (elements) {
                    elements.statusInput.value = config.statusCode;
                    elements.delayInput.value = config.delay;
                    elements.bodyInput.value = JSON.stringify(config.body, null, 2);
                }
            });
        });

        // Handle update success
        socket.on('updateSuccess', ({ endpoint, timestamp }) => {
            const elements = container[endpoint];
            if (elements) {
                elements.updateBtn.disabled = false;
                elements.updateStatus.textContent = `Updated successfully at ${timestamp}`;
                elements.updateStatus.classList.remove('text-warning');
                elements.updateStatus.classList.add('text-success', 'show');
                
                // Reset the status message after animation
                setTimeout(() => {
                    elements.updateStatus.classList.remove('show');
                }, 5000);
            }
        });
    </script>
</body>
</html> 